<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate PDF Editor (Fixed)</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #1e293b; margin-bottom: 8px; }
        p.subtitle { text-align: center; color: #64748b; margin-bottom: 24px; }

        .dropzone { border: 2px dashed #cbd5e1; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.2s; background: #f1f5f9; }
        .dropzone:hover { border-color: var(--primary); background: #eff6ff; }

        #pages-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 30px; min-height: 200px; }
        .page-card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; text-align: center; cursor: grab; position: relative; transition: 0.2s; }
        .page-card:active { cursor: grabbing; }
        .page-card canvas { width: 100%; border-radius: 4px; border: 1px solid #f1f5f9; margin-bottom: 8px; }
        .page-label { font-size: 12px; color: #475569; font-weight: 600; display: block; margin-bottom: 8px; }

        .btn-del { background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; width: 100%; }
        .btn-del:hover { opacity: 0.9; }
        
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        #save-btn { background: var(--primary); color: white; border: none; padding: 12px 28px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        #save-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .sortable-ghost { opacity: 0.3; transform: scale(0.9); }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ† PDF Ultimate Editor</h2>
    <p class="subtitle">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á ‡πÅ‡∏ï‡∏Å‡∏´‡∏ô‡πâ‡∏≤ ‡∏Ç‡∏¢‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏ä‡∏≠‡∏ö</p>

    <div class="dropzone" id="dropzone">
        <strong>üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</strong>
        <input type="file" id="file-input" accept="application/pdf" multiple style="display: none;">
    </div>

    <div id="pages-container"></div>

    <div class="footer">
        <span id="counter" style="color: #64748b;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0</span>
        <button id="save-btn" disabled>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏´‡∏°‡πà</button>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    const { PDFDocument } = PDFLib;

    const fileInput = document.getElementById('file-input');
    const container = document.getElementById('pages-container');
    const dropzone = document.getElementById('dropzone');
    const saveBtn = document.getElementById('save-btn');
    const counter = document.getElementById('counter');

    let allPagesData = []; 

    new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: () => {
            const newOrder = [];
            container.querySelectorAll('.page-card').forEach(card => {
                // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ ID ‡∏¢‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (allPagesData[card.dataset.id]) {
                    newOrder.push(allPagesData[card.dataset.id]);
                }
            });
            allPagesData = newOrder;
            renderAll(); 
        }
    });

    dropzone.onclick = () => fileInput.click();

    fileInput.onchange = async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            // 1. ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤ ArrayBuffer
            const originalBytes = await file.arrayBuffer();
            
            // 2. *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç *** ‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏ô‡∏≤ (Clone) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ pdf.js
            // ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ pdf.js ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Worker ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
            const bytesForDisplay = originalBytes.slice(0); 

            const pdf = await pdfjsLib.getDocument({data: bytesForDisplay}).promise;
            
            for (let i = 1; i <= pdf.numPages; i++) {
                // 3. ‡πÄ‡∏Å‡πá‡∏ö originalBytes ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô Save (pdf-lib)
                allPagesData.push({ bytes: originalBytes, pageIndex: i - 1 });
                
                // ‡∏™‡πà‡∏á pdf object ‡πÑ‡∏õ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÉ‡∏ä‡πâ bytesForDisplay ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô getDocument)
                await renderThumbnail(pdf, i, allPagesData.length - 1);
            }
        }
        updateUI();
        fileInput.value = ""; // Reset input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    };

    async function renderThumbnail(pdf, pageNum, dataIndex) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 0.3 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({ canvasContext: context, viewport: viewport }).promise;

        const card = document.createElement('div');
        card.className = 'page-card';
        card.dataset.id = dataIndex;
        card.innerHTML = `<span class="page-label">Page ${pageNum}</span>`;
        card.prepend(canvas);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-del';
        delBtn.innerText = '‡∏•‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ';
        delBtn.onclick = () => {
            card.remove();
            updateUI(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        };
        card.appendChild(delBtn);

        container.appendChild(card);
    }

    function renderAll() {
        container.querySelectorAll('.page-card').forEach((card, index) => {
            card.dataset.id = index;
        });
    }

    function updateUI() {
        const total = container.querySelectorAll('.page-card').length;
        counter.innerText = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total}`;
        saveBtn.disabled = total === 0;
    }

    saveBtn.onclick = async () => {
        saveBtn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå...';
        saveBtn.disabled = true;

        try {
            const mergedPdf = await PDFDocument.create();
            // ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å DOM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            const cards = container.querySelectorAll('.page-card');
            
            // Cache ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î PDF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ parse ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÜ
            const loadedDocs = new Map();

            for (const card of cards) {
                const data = allPagesData[card.dataset.id];
                if (!data) continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠

                if (!loadedDocs.has(data.bytes)) {
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å bytes ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÑ‡∏ß‡πâ
                    loadedDocs.set(data.bytes, await PDFDocument.load(data.bytes));
                }
                const sourceDoc = loadedDocs.get(data.bytes);
                const [copiedPage] = await mergedPdf.copyPages(sourceDoc, [data.pageIndex]);
                mergedPdf.addPage(copiedPage);
            }

            const pdfBytes = await mergedPdf.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `merged_${Date.now()}.pdf`;
            a.click();
            URL.revokeObjectURL(url);
            
        } catch (err) {
            console.error(err);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
        } finally {
            saveBtn.innerText = '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏´‡∏°‡πà';
            saveBtn.disabled = false;
        }
    };
</script>

</body>
</html>